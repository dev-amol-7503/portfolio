import{A as u,B as A,h as C,l,m as I,o as E,p as T,q as w,r as k,s as i,t as g,u as m,w as _,x as b,y as p,z as S}from"./chunk-NDJZWFGI.js";import{a as d,b as h,ca as L,f as s,ia as y}from"./chunk-F3LZLUOA.js";var N=(()=>{class f{firestore=y(I);toastr=y(C);useLocalStorage=!1;LOCAL_STORAGE_KEY="matrix_notes_tutorials";LOCAL_STORAGE_COMMENTS_KEY="matrix_notes_comments";LOCAL_STORAGE_BOOKMARKS_KEY="matrix_notes_bookmarks";tutorialsCollection=w(this.firestore,"tutorials");commentsCollection=w(this.firestore,"tutorial_comments");bookmarksCollection=w(this.firestore,"tutorial_bookmarks");constructor(){this.testFirebaseConnection()}testFirebaseConnection(){return s(this,null,function*(){try{if(!this.firestore)throw new Error("Firestore not available");let t=p(this.tutorialsCollection,_(1));yield m(t),console.log("Firebase connection successful"),this.useLocalStorage=!1}catch(t){console.error("Firebase connection failed, using localStorage:",t),this.useLocalStorage=!0,this.toastr.warning("Using local storage mode for tutorials")}})}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}getCurrentUserId(){let t=localStorage.getItem("matrix_notes_user_id");return t||(t="user_"+Math.random().toString(36).substr(2,9),localStorage.setItem("matrix_notes_user_id",t)),t}deepCleanObject(t){if(t!=null){if(Array.isArray(t))return t.map(e=>this.deepCleanObject(e)).filter(e=>e!==void 0);if(typeof t=="object"){let e={};for(let[r,o]of Object.entries(t)){let a=this.deepCleanObject(o);a!==void 0&&(e[r]=a)}return Object.keys(e).length>0?e:void 0}return t}}getTutorialsFromLocalStorage(){try{let t=localStorage.getItem(this.LOCAL_STORAGE_KEY);return t?JSON.parse(t):[]}catch(t){return console.error("Error reading from localStorage:",t),[]}}saveTutorialsToLocalStorage(t){try{localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t))}catch(e){console.error("Error saving to localStorage:",e)}}getCommentsFromLocalStorage(){try{let t=localStorage.getItem(this.LOCAL_STORAGE_COMMENTS_KEY);return t?JSON.parse(t):[]}catch(t){return console.error("Error reading comments from localStorage:",t),[]}}saveCommentsToLocalStorage(t){try{localStorage.setItem(this.LOCAL_STORAGE_COMMENTS_KEY,JSON.stringify(t))}catch(e){console.error("Error saving comments to localStorage:",e)}}createTutorial(t){return s(this,null,function*(){if(this.useLocalStorage)return this.createTutorialLocalStorage(t);try{return yield this.createTutorialFirebase(t)}catch(e){return console.warn("Firebase failed, falling back to localStorage:",e),this.useLocalStorage=!0,this.toastr.warning("Switched to local storage mode"),this.createTutorialLocalStorage(t)}})}createTutorialFirebase(t){return s(this,null,function*(){let e=this.generateId(),r={id:e,title:t.title||"Untitled Tutorial",description:t.description||"",content:(t.content||[]).map(n=>({id:n.id||Date.now().toString(),type:n.type||"text",content:n.content||"",order:n.order||0,language:n.language,metadata:n.metadata})),tags:t.tags||[],category:t.category||"general",author:t.author||"admin",published:t.published||!1,featured:t.featured||!1,createdAt:new Date,updatedAt:new Date,readingTime:t.readingTime||5,difficulty:t.difficulty||"beginner",coverImage:t.coverImage,bookmarks:[],views:0,likes:0},o=h(d({},r),{createdAt:l.fromDate(r.createdAt),updatedAt:l.fromDate(r.updatedAt)}),a=this.deepCleanObject(o);console.log("Creating tutorial in Firebase with data:",a);let c=i(this.firestore,"tutorials",e);return yield S(c,a),this.toastr.success("Tutorial created successfully in Firebase"),e})}createTutorialLocalStorage(t){let e=this.generateId(),r={id:e,title:t.title||"Untitled Tutorial",description:t.description||"",content:t.content||[],tags:t.tags||[],category:t.category||"general",author:t.author||"admin",published:t.published||!1,featured:t.featured||!1,createdAt:new Date,updatedAt:new Date,readingTime:t.readingTime||5,difficulty:t.difficulty||"beginner",coverImage:t.coverImage,bookmarks:[],views:0,likes:0},o=this.getTutorialsFromLocalStorage();return o.push(r),this.saveTutorialsToLocalStorage(o),this.toastr.success("Tutorial created successfully in local storage"),e}getAllTutorials(){return s(this,null,function*(){if(this.useLocalStorage)return this.getTutorialsFromLocalStorage();try{let t=p(this.tutorialsCollection,b("createdAt","desc"));return(yield m(t)).docs.map(r=>{let o=r.data();return{id:o.id,title:o.title,description:o.description,content:o.content||[],tags:o.tags||[],category:o.category,author:o.author,published:o.published,featured:o.featured,createdAt:o.createdAt?.toDate(),updatedAt:o.updatedAt?.toDate(),publishedAt:o.publishedAt?.toDate(),readingTime:o.readingTime,difficulty:o.difficulty,coverImage:o.coverImage,bookmarks:o.bookmarks||[],views:o.views||0,likes:o.likes||0}})}catch(t){return console.warn("Firebase failed, falling back to localStorage:",t),this.useLocalStorage=!0,this.getTutorialsFromLocalStorage()}})}getPublishedTutorials(){return s(this,null,function*(){return(yield this.getAllTutorials()).filter(e=>e.published)})}getTutorial(t){return s(this,null,function*(){if(this.useLocalStorage)return this.getTutorialsFromLocalStorage().find(r=>r.id===t)||null;try{let e=i(this.firestore,"tutorials",t),r=yield g(e);if(!r.exists())return null;let o=r.data();return{id:o.id,title:o.title,description:o.description,content:o.content||[],tags:o.tags||[],category:o.category,author:o.author,published:o.published,featured:o.featured,createdAt:o.createdAt?.toDate(),updatedAt:o.updatedAt?.toDate(),publishedAt:o.publishedAt?.toDate(),readingTime:o.readingTime,difficulty:o.difficulty,coverImage:o.coverImage,bookmarks:o.bookmarks||[],views:o.views||0,likes:o.likes||0}}catch(e){return console.warn("Firebase failed, falling back to localStorage:",e),this.useLocalStorage=!0,this.getTutorialsFromLocalStorage().find(o=>o.id===t)||null}})}updateTutorial(t,e){return s(this,null,function*(){if(this.useLocalStorage){let r=this.getTutorialsFromLocalStorage(),o=r.findIndex(a=>a.id===t);o!==-1&&(r[o]=h(d(d({},r[o]),e),{updatedAt:new Date}),this.saveTutorialsToLocalStorage(r));return}try{let r=i(this.firestore,"tutorials",t),o=this.deepCleanObject(h(d({},e),{updatedAt:l.fromDate(new Date)}));yield u(r,o)}catch(r){console.warn("Firebase failed, falling back to localStorage:",r),this.useLocalStorage=!0,yield this.updateTutorial(t,e)}})}deleteTutorial(t){return s(this,null,function*(){if(this.useLocalStorage){let r=this.getTutorialsFromLocalStorage().filter(o=>o.id!==t);this.saveTutorialsToLocalStorage(r);return}try{let e=i(this.firestore,"tutorials",t);yield k(e)}catch(e){console.warn("Firebase failed, falling back to localStorage:",e),this.useLocalStorage=!0,yield this.deleteTutorial(t)}})}publishTutorial(t){return s(this,null,function*(){if(this.useLocalStorage){let e=this.getTutorialsFromLocalStorage(),r=e.find(o=>o.id===t);if(r)r.published=!0,r.publishedAt=new Date,r.updatedAt=new Date,this.saveTutorialsToLocalStorage(e),this.toastr.success("Tutorial published successfully");else throw this.toastr.error("Tutorial not found"),new Error("Tutorial not found");return}try{let e=i(this.firestore,"tutorials",t);if(!(yield g(e)).exists())throw this.toastr.error("Tutorial not found"),new Error("Tutorial not found");yield u(e,{published:!0,publishedAt:l.fromDate(new Date),updatedAt:l.fromDate(new Date)}),this.toastr.success("Tutorial published successfully")}catch(e){throw console.error("Error publishing tutorial:",e),this.toastr.error("Failed to publish tutorial"),e}})}unpublishTutorial(t){return s(this,null,function*(){if(this.useLocalStorage){let e=this.getTutorialsFromLocalStorage(),r=e.find(o=>o.id===t);if(r)r.published=!1,r.updatedAt=new Date,this.saveTutorialsToLocalStorage(e),this.toastr.success("Tutorial unpublished successfully");else throw this.toastr.error("Tutorial not found"),new Error("Tutorial not found");return}try{let e=i(this.firestore,"tutorials",t);if(!(yield g(e)).exists())throw this.toastr.error("Tutorial not found"),new Error("Tutorial not found");yield u(e,{published:!1,updatedAt:l.fromDate(new Date)}),this.toastr.success("Tutorial unpublished successfully")}catch(e){throw console.error("Error unpublishing tutorial:",e),this.toastr.error("Failed to unpublish tutorial"),e}})}addContentToTutorial(t,e){return s(this,null,function*(){try{let r=i(this.firestore,"tutorials",t),o=this.deepCleanObject(e);yield u(r,{content:T(o),updatedAt:l.fromDate(new Date)})}catch(r){throw console.error("Error adding content:",r),r}})}addComment(t,e){return s(this,null,function*(){try{let r=this.generateId(),o={id:r,tutorialId:t,userId:e.userId||this.getCurrentUserId(),userName:e.userName||"Anonymous User",content:e.content||"",createdAt:new Date,parentId:e.parentId},a=this.deepCleanObject(o),c=i(this.firestore,"tutorial_comments",r);return yield S(c,h(d({},a),{createdAt:l.fromDate(o.createdAt)})),r}catch(r){throw console.error("Error adding comment:",r),r}})}getComments(t){return s(this,null,function*(){try{let e=p(this.commentsCollection,A("tutorialId","==",t),b("createdAt","asc"));return(yield m(e)).docs.map(o=>{let a=o.data();return{id:a.id,tutorialId:a.tutorialId,userId:a.userId,userName:a.userName,content:a.content,createdAt:a.createdAt?.toDate(),parentId:a.parentId}})}catch(e){throw console.error("Error getting comments:",e),e}})}toggleBookmark(t,e){return s(this,null,function*(){try{let r=e||this.getCurrentUserId(),o=`${r}_${t}`,a=i(this.firestore,"tutorial_bookmarks",o);if((yield g(a)).exists()){yield k(a);let n=i(this.firestore,"tutorials",t);return yield u(n,{bookmarks:E(r)}),!1}else{let n={id:o,tutorialId:t,userId:r,createdAt:new Date},O=this.deepCleanObject(n);yield S(a,h(d({},O),{createdAt:l.fromDate(n.createdAt)}));let v=i(this.firestore,"tutorials",t);return yield u(v,{bookmarks:T(r)}),!0}}catch(r){throw console.error("Error toggling bookmark:",r),r}})}isBookmarked(t,e){return s(this,null,function*(){try{let o=`${e||this.getCurrentUserId()}_${t}`,a=i(this.firestore,"tutorial_bookmarks",o);return(yield g(a)).exists()}catch(r){return console.error("Error checking bookmark:",r),!1}})}getUserBookmarks(t){return s(this,null,function*(){try{let e=t||this.getCurrentUserId(),r=p(this.bookmarksCollection,A("userId","==",e),b("createdAt","desc"));return(yield m(r)).docs.map(a=>{let c=a.data();return{id:c.id,tutorialId:c.tutorialId,userId:c.userId,createdAt:c.createdAt?.toDate()}})}catch(e){throw console.error("Error getting user bookmarks:",e),e}})}searchTutorials(t){return s(this,null,function*(){try{return(yield this.getPublishedTutorials()).filter(r=>r.title.toLowerCase().includes(t.toLowerCase())||r.description.toLowerCase().includes(t.toLowerCase())||r.tags.some(o=>o.toLowerCase().includes(t.toLowerCase()))||r.category.toLowerCase().includes(t.toLowerCase()))}catch(e){throw console.error("Error searching tutorials:",e),e}})}incrementViews(t){return s(this,null,function*(){try{let e=i(this.firestore,"tutorials",t),r=yield this.getTutorial(t);r&&(yield u(e,{views:(r.views||0)+1}))}catch(e){console.error("Error incrementing views:",e)}})}incrementLikes(t){return s(this,null,function*(){try{let e=i(this.firestore,"tutorials",t),r=yield this.getTutorial(t);r&&(yield u(e,{likes:(r.likes||0)+1}))}catch(e){console.error("Error incrementing likes:",e)}})}static \u0275fac=function(e){return new(e||f)};static \u0275prov=L({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})();export{N as a};
