<div class="tutorial-detail-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading tutorial content...</p>
    </div>
  </div>

  <!-- Tutorial Content -->
  <div *ngIf="!isLoading && tutorial" class="tutorial-wrapper">
    <!-- Sticky Progress Bar -->
    <div class="reading-progress" *ngIf="!isLoading">
      <div class="progress-bar" [style.width.%]="getScrollProgress()"></div>
    </div>

    <div class="container-fluid">
      <div class="row g-4">
        <!-- Main Content -->
        <div class="col-xxl-9 col-lg-8">
          <article class="tutorial-article">
            <!-- Enhanced Header -->
            <header class="article-header">
              <div class="header-top">
                <nav class="breadcrumb-nav">
                  <a [routerLink]="['/tutorials']" class="breadcrumb-link">
                    <i class="fas fa-arrow-left"></i>
                    All Tutorials
                  </a>
                  <span class="breadcrumb-separator">/</span>
                  <a [routerLink]="['/tutorials']" [queryParams]="{ category: tutorial.category }"
                    class="breadcrumb-link">
                    {{ tutorial.category | titlecase }}
                  </a>
                </nav>

                <div class="header-actions">
                  <button class="btn btn-icon" (click)="themeService.toggleTheme()" title="Toggle theme">
                    <i class="fas" [class.fa-moon]="!themeService.isDarkTheme()"
                      [class.fa-sun]="themeService.isDarkTheme()"></i>
                  </button>
                </div>
              </div>

              <div class="header-main">
                <div class="title-section">
                  <div class="meta-badges">
                    <span class="badge category">{{ tutorial.category | titlecase }}</span>
                    <span class="badge difficulty" [class]="tutorial.difficulty">
                      {{ tutorial.difficulty | titlecase }}
                    </span>
                    <span class="badge reading-time">
                      <i class="fas fa-clock"></i>
                      {{ tutorial.readingTime }} min read
                    </span>
                  </div>

                  <h1 class="tutorial-title">{{ tutorial.title }}</h1>
                  <p class="tutorial-description">{{ tutorial.description }}</p>

                  <div class="header-stats">
                    <div class="stats">
                      <span class="stat">
                        <i class="fas fa-eye"></i>
                        {{ tutorial.views || 0 }} views
                      </span>
                      <span class="stat">
                        <i class="fas fa-heart"></i>
                        {{ tutorial.likes || 0 }} likes
                      </span>
                      <span class="stat">
                        <i class="fas fa-calendar"></i>
                        {{ tutorial.createdAt | date:'mediumDate' }}
                      </span>
                    </div>

                    <div class="action-buttons">
                      <button class="btn btn-like" (click)="likeTutorial()" [class.liked]="hasLiked">
                        <i [class]="hasLiked ? 'fas fa-heart' : 'far fa-heart'"></i>
                        {{ tutorial.likes || 0 }}
                      </button>

                      <div class="dropdown">
                        <button class="btn btn-icon" data-bs-toggle="dropdown">
                          <i class="fas fa-share-alt"></i>
                        </button>
                        <div class="dropdown-menu">
                          <a class="dropdown-item" (click)="shareOnTwitter()">
                            <i class="fab fa-twitter"></i> Twitter
                          </a>
                          <a class="dropdown-item" (click)="shareOnLinkedIn()">
                            <i class="fab fa-linkedin"></i> LinkedIn
                          </a>
                          <a class="dropdown-item" (click)="copyLink()">
                            <i class="fas fa-link"></i> Copy Link
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tags & Technologies -->
                <div class="header-tags">
                  <div class="tags-row" *ngIf="tutorial.tags?.length">
                    <div class="tags-container">
                      <span *ngFor="let tag of tutorial.tags" class="tag">
                        <i class="fas fa-hashtag"></i>
                        {{ tag }}
                      </span>
                    </div>
                  </div>

                  <div class="tags-row" *ngIf="tutorial.technologies?.length">
                    <label class="tags-label">Technologies:</label>
                    <div class="tags-container">
                      <span *ngFor="let tech of tutorial.technologies" class="tag tech-tag">
                        <i class="fas fa-code"></i>
                        {{ tech }}
                      </span>
                    </div>
                  </div>

                  <div class="tags-row" *ngIf="tutorial.prerequisites?.length">
                    <label class="tags-label">Prerequisites:</label>
                    <div class="tags-container">
                      <span *ngFor="let prereq of tutorial.prerequisites" class="tag prereq-tag">
                        <i class="fas fa-check-circle"></i>
                        {{ prereq }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </header>

            <!-- Learning Objectives -->
            <div *ngIf="tutorial.learningObjectives?.length" class="learning-objectives">
              <div class="objectives-header">
                <i class="fas fa-bullseye"></i>
                <h3>What You'll Learn</h3>
              </div>
              <div class="objectives-grid">
                <div *ngFor="let objective of tutorial.learningObjectives; let i = index" class="objective-card">
                  <div class="objective-number">{{ i + 1 }}</div>
                  <div class="objective-text">{{ objective }}</div>
                </div>
              </div>
            </div>

            <!-- Roadmap Context -->
            <div *ngIf="currentRoadmapStep" class="roadmap-context">
              <div class="context-card">
                <div class="context-header">
                  <i class="fas fa-map-marker-alt"></i>
                  <div class="context-title">
                    <h4>{{ currentRoadmapStep.title }}</h4>
                    <span class="progress-text">Step {{ getCurrentTopicNumber() }} of {{ totalTopicsInStep }}</span>
                  </div>
                </div>
                <div class="context-body">
                  <p class="context-description">{{ currentRoadmapStep.description }}</p>

                  <div class="progress-section">
                    <div class="progress-info">
                      <span>Progress</span>
                      <span>{{ getStepProgress() }}%</span>
                    </div>
                    <div class="progress">
                      <div class="progress-bar" [style.width.%]="getStepProgress()"></div>
                    </div>
                  </div>

                  <div class="navigation-buttons">
                    <button class="btn btn-outline" (click)="navigateToPreviousTopic()"
                      [disabled]="!hasPreviousTopic()">
                      <i class="fas fa-arrow-left"></i>
                      Previous
                    </button>
                    <button class="btn btn-primary" (click)="navigateToNextTopic()" [disabled]="!hasNextTopic()">
                      Next
                      <i class="fas fa-arrow-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Main Content Area -->
            <div class="content-main">
              <!-- Enhanced Content Renderer -->
              <div *ngIf="tutorial.content?.length" class="ckeditor-content">
                <div *ngFor="let content of tutorial.content; let i = index" class="content-block"
                  [id]="'section-' + i">

                  <!-- Render CKEditor HTML content directly -->
                  <div *ngIf="content.type === 'text' && content.content" class="rich-text-content"
                    [innerHTML]="content.content | safeHtml"></div>

                  <!-- Code blocks from CKEditor -->
                  <div *ngIf="content.type === 'code'" class="code-block-wrapper">
                    <div class="code-header">
                      <span class="language-badge">{{ content.language || 'text' }}</span>
                      <button class="btn btn-copy" (click)="copyCode(content.content)">
                        <i class="fas fa-copy"></i>
                        Copy
                      </button>
                    </div>
                    <pre class="code-content"><code>{{ content.content }}</code></pre>
                  </div>
                </div>
              </div>

              <!-- Fallback for main content -->
              <div *ngIf="!tutorial.content?.length && mainContent" class="rich-text-content main-content"
                [innerHTML]="mainContent"></div>
            </div>

            <!-- Enhanced Footer -->
            <footer class="article-footer">
              <div class="completion-section">
                <div class="completion-header">
                  <i class="fas fa-trophy"></i>
                  <h3>Congratulations! ðŸŽ‰</h3>
                </div>
                <p class="completion-text">You've completed this tutorial. Ready to continue your learning journey?</p>

                <div class="completion-actions">
                  <button *ngIf="hasNextTopic()" class="btn btn-primary" (click)="navigateToNextTopic()">
                    <i class="fas fa-arrow-right"></i>
                    Continue to Next Topic
                  </button>
                  <button *ngIf="!hasNextTopic() && getNextRoadmapStep()" class="btn btn-success"
                    (click)="navigateToRoadmapStep(getNextRoadmapStep()!.id)">
                    <i class="fas fa-graduation-cap"></i>
                    Next Step: {{ getNextRoadmapStep()!.title }}
                  </button>
                  <a [routerLink]="['/tutorials']" class="btn btn-outline">
                    <i class="fas fa-book-open"></i>
                    Browse More Tutorials
                  </a>
                </div>
              </div>

              <div class="feedback-section">
                <h5>Was this tutorial helpful?</h5>
                <div class="feedback-buttons">
                  <button class="btn btn-feedback" (click)="likeTutorial()">
                    <i class="fas fa-thumbs-up"></i> Yes, it was helpful
                  </button>
                  <button class="btn btn-feedback outline">
                    <i class="fas fa-comment-dots"></i> Leave detailed feedback
                  </button>
                </div>
              </div>
            </footer>
          </article>
        </div>

        <!-- Enhanced Sidebar -->
        <div class="col-xxl-3 col-lg-4">
          <aside class="tutorial-sidebar">
            <!-- Table of Contents -->
            <div class="sidebar-card toc-card">
              <div class="card-header">
                <i class="fas fa-list-ol"></i>
                <h5>Table of Contents</h5>
              </div>
              <div class="card-body">
                <nav class="toc-nav">
                  <ul>
                    <li *ngFor="let item of getEnhancedTableOfContents()" class="toc-item"
                      [class.active]="activeSectionId === item.id" [class]="'toc-level-' + item.level">
                      <a [href]="'#' + item.id" (click)="scrollToSection(item.id, $event)" class="toc-link">
                        <span class="toc-bullet"></span>
                        <span class="toc-text">{{ item.title }}</span>
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>

            <!-- Quick Info -->
            <div class="sidebar-card info-card">
              <div class="card-header">
                <i class="fas fa-info-circle"></i>
                <h5>Tutorial Info</h5>
              </div>
              <div class="card-body">
                <div class="info-grid">
                  <div class="info-item">
                    <i class="fas fa-chart-line"></i>
                    <div class="info-content">
                      <div class="info-label">Difficulty</div>
                      <div class="info-value">{{ tutorial.difficulty | titlecase }}</div>
                    </div>
                  </div>
                  <div class="info-item">
                    <i class="fas fa-tag"></i>
                    <div class="info-content">
                      <div class="info-label">Category</div>
                      <div class="info-value">{{ tutorial.category | titlecase }}</div>
                    </div>
                  </div>
                  <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <div class="info-content">
                      <div class="info-label">Duration</div>
                      <div class="info-value">{{ tutorial.readingTime }} min</div>
                    </div>
                  </div>
                  <div class="info-item">
                    <i class="fas fa-calendar"></i>
                    <div class="info-content">
                      <div class="info-label">Published</div>
                      <div class="info-value">{{ tutorial.createdAt | date:'mediumDate' }}</div>
                    </div>
                  </div>
                  <div class="info-item" *ngIf="tutorial.author">
                    <i class="fas fa-user"></i>
                    <div class="info-content">
                      <div class="info-label">Author</div>
                      <div class="info-value">{{ tutorial.author }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Related Tutorials -->
            <div class="sidebar-card related-card" *ngIf="relatedTutorials.length > 0">
              <div class="card-header">
                <i class="fas fa-book-open"></i>
                <h5>Related Tutorials</h5>
              </div>
              <div class="card-body">
                <div class="related-list">
                  <a *ngFor="let related of relatedTutorials" [routerLink]="['/tutorials', related.id]"
                    class="related-item">
                    <h6>{{ related.title }}</h6>
                    <p class="related-description">{{ related.description | truncate:80 }}</p>
                    <div class="related-meta">
                      <span class="badge" [class]="related.difficulty">
                        {{ related.difficulty | titlecase }}
                      </span>
                      <span class="reading-time">{{ related.readingTime }} min</span>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <!-- Not Found State -->
  <div *ngIf="!isLoading && !tutorial" class="not-found-container">
    <div class="not-found-content">
      <i class="fas fa-book-open"></i>
      <h3>Tutorial Not Found</h3>
      <p>The tutorial you're looking for doesn't exist or has been removed.</p>
      <a [routerLink]="['/tutorials']" class="btn btn-primary">
        Browse All Tutorials
      </a>
    </div>
  </div>

  <!-- Back to Top Button -->
  <button class="back-to-top-btn" (click)="scrollToTop()" [class.show]="showBackToTop" title="Back to top">
    <i class="fas fa-arrow-up"></i>
  </button>
</div>